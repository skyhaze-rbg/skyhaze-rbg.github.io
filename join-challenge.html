<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3475887870885804"
    crossorigin="anonymous"></script>

  <title>Skydle - Join Challenge</title>
  <link rel="stylesheet" href="src/join-challenge.css">

  <!-- Game scripts -->
  <script src="./constants.js"></script>
  <script src="./wordle.js"></script>
  <script src="./state.js"></script>
  <script src="./app.js"></script>
  <script>
    // Set friends challenge mode
    window.currentGameMode = 'friends';
    console.log("Join Challenge mode loaded");
  </script>
</head>

<body class="friends-body">
  <!-- App div -->
  <div id="app" class="friends-app">
    <!-- Friends Challenge Navigation -->
    <nav class="friends-nav">
      <div class="friends-nav-container">
        <button type="button" id="menu-button" class="friends-menu-btn"
          onclick="window.location.href='friends-challenge.html'">
          ‚Üê Back to Menu
        </button>
        <div class="friends-title">
          <span id="nav-title">üîó Join Challenge</span>
        </div>
        <div class="friends-nav-right"></div>
      </div>
    </nav>

    <!-- Join Challenge Form -->
    <div id="join-challenge-form" class="friends-container">
      <div class="friends-card">
        <h2 class="friends-card-title">Join a Challenge</h2>
        <div class="form-content">
          <div class="input-group">
            <label for="challenge-code-input">Enter challenge code:</label>
            <input type="text" id="challenge-code-input" class="friends-input" placeholder="ABC123">
            <div class="input-hint">Paste the code your friend shared with you</div>
          </div>
          <button class="friends-btn start-btn" onclick="startFriendsChallenge()">
            <span class="friends-icon">üöÄ</span>
            Start Challenge
          </button>
          <div id="code-error" class="error-message" style="display: none;">
            Invalid challenge code. Please check and try again.
          </div>
        </div>
        <button class="friends-back-btn" onclick="window.location.href='friends-challenge.html'">‚Üê Back to
          Options</button>
      </div>
    </div>

    <!-- Friends Challenge Game -->
    <div id="friends-game" class="friends-game" style="display: none;">
      <!-- Challenge Info -->
      <div class="challenge-info">
        <div class="challenge-creator">Challenge by: <span id="creator-name">Friend</span></div>
        <button type="button" id="reset-button" class="friends-reset-btn">New Attempt</button>
      </div>

      <!-- Game Board -->
      <div id="board-container" class="friends-board-container">
        <div id="board" class="friends-board">
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
        </div>
      </div>

      <!-- Friends Keyboard -->
      <div id="keyboard-container" class="friends-keyboard-container">
        <div id="keyboard" class="friends-keyboard">
          <div class="row">
            <button data-key="q" class="friends-key">q</button>
            <button data-key="w" class="friends-key">w</button>
            <button data-key="e" class="friends-key">e</button>
            <button data-key="r" class="friends-key">r</button>
            <button data-key="t" class="friends-key">t</button>
            <button data-key="y" class="friends-key">y</button>
            <button data-key="u" class="friends-key">u</button>
            <button data-key="i" class="friends-key">i</button>
            <button data-key="o" class="friends-key">o</button>
            <button data-key="p" class="friends-key">p</button>
          </div>
          <div class="row">
            <span class="half"></span>
            <button data-key="a" class="friends-key">a</button>
            <button data-key="s" class="friends-key">s</button>
            <button data-key="d" class="friends-key">d</button>
            <button data-key="f" class="friends-key">f</button>
            <button data-key="g" class="friends-key">g</button>
            <button data-key="h" class="friends-key">h</button>
            <button data-key="j" class="friends-key">j</button>
            <button data-key="k" class="friends-key">k</button>
            <button data-key="l" class="friends-key">l</button>
            <span class="half"></span>
          </div>
          <div class="row">
            <button data-key="Enter" class="friends-key one-and-a-half">enter</button>
            <button data-key="z" class="friends-key">z</button>
            <button data-key="x" class="friends-key">x</button>
            <button data-key="c" class="friends-key">c</button>
            <button data-key="v" class="friends-key">v</button>
            <button data-key="b" class="friends-key">b</button>
            <button data-key="n" class="friends-key">n</button>
            <button data-key="m" class="friends-key">m</button>
            <button data-key="Backspace" class="friends-key one-and-a-half">
              <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">
                <path fill="currentColor"
                  d="M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.89 1.59.89h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H7.07L2.4 12l4.66-7H22v14zm-11.59-2L14 13.41 17.59 17 19 15.59 15.41 12 19 8.41 17.59 7 14 10.59 10.41 7 9 8.41 12.59 12 9 15.59z">
                </path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"
    type="module"></script>

  <script>
    // Challenge code decoding
    function decodeWord(code) {
      console.log('Decoding code:', code);

      try {
        // Convert from base36 back to number string
        const numberString = parseInt(code, 36).toString();
        console.log('Number string:', numberString);

        // Remove the last 2 digits (random suffix)
        const wordNumbers = numberString.slice(0, -2);
        console.log('Word numbers:', wordNumbers);

        // Convert back to letters
        let decoded = '';
        for (let i = 0; i < wordNumbers.length; i += 2) {
          const letterValue = parseInt(wordNumbers.substr(i, 2));
          if (letterValue >= 10 && letterValue <= 35) {
            decoded += String.fromCharCode(letterValue - 10 + 65);
          } else {
            console.log('Invalid letter value:', letterValue);
            return null;
          }
        }

        console.log('Decoded word:', decoded);

        // Validate word length and format
        if (decoded.length === 5 && /^[A-Z]+$/.test(decoded)) {
          return decoded;
        }

        console.log('Validation failed');
        return null;
      } catch (e) {
        console.error('Decode error:', e);
        return null;
      }
    }

    // Start friends challenge
    function startFriendsChallenge() {
      const codeInput = document.getElementById('challenge-code-input');
      const code = codeInput.value.trim().toUpperCase();

      if (!code) {
        alert('Please enter a challenge code');
        return;
      }

      const word = decodeWord(code);
      if (!word) {
        document.getElementById('code-error').style.display = 'block';
        return;
      }

      // Hide error and start game
      document.getElementById('code-error').style.display = 'none';

      // Initialize game with the decoded word
      window.challengeWord = word;
      startFriendsGame(word);
    }

    // Start the friends game
    async function startFriendsGame(customWord) {
      // Hide form, show game
      document.getElementById('join-challenge-form').style.display = 'none';
      document.getElementById('friends-game').style.display = 'block';

      // Update navigation title
      document.getElementById('nav-title').innerHTML = 'üéÆ Playing Challenge';

      // Initialize game with custom word
      if (window.initializeGame) {
        await window.initializeGame(customWord);
      }
    }

    // Reset button functionality
    document.addEventListener('DOMContentLoaded', () => {
      // Check for challenge code in URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const codeFromUrl = urlParams.get('code');
      if (codeFromUrl) {
        document.getElementById('challenge-code-input').value = codeFromUrl;
        // Auto-start if valid code is provided in URL
        setTimeout(() => startFriendsChallenge(), 500);
      }

      // Reset button functionality
      const resetButton = document.getElementById('reset-button');
      if (resetButton) {
        resetButton.addEventListener('click', function () {
          if (window.challengeWord) {
            startFriendsGame(window.challengeWord);
          }
        });
      }

      // Input validation for code input
      document.getElementById('challenge-code-input').addEventListener('input', function (e) {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      });

      console.log("Join Challenge page loaded");
    });
  </script>
</body>

</html>