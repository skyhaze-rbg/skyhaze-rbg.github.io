<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3475887870885804"
    crossorigin="anonymous"></script>

  <title>Skydle - Friends Challenge</title>
  <link rel="stylesheet" href="src/style.css">
  <link rel="stylesheet" href="src/friends-style.css">

  <!-- Game scripts -->
  <script src="./constants.js"></script>
  <script src="./wordle.js"></script>
  <script src="./state.js"></script>
  <script src="./app.js"></script>
  <script>
    // Set friends challenge mode
    window.currentGameMode = 'friends';
    console.log("Friends Challenge mode loaded");
  </script>
</head>

<body class="friends-body">
  <!-- App div -->
  <div id="app" class="friends-app">
    <!-- Friends Challenge Navigation -->
    <nav class="friends-nav">
      <div class="friends-nav-container">
        <button type="button" id="menu-button" class="friends-menu-btn" onclick="window.location.href='index.html'">
          ‚Üê Back to Menu
        </button>
        <div class="friends-title">
          <span>üë• Friends Challenge</span>
        </div>
        <div class="friends-nav-right"></div>
      </div>
    </nav>

    <!-- Main Friends Menu -->
    <div id="friends-main-menu" class="friends-container">
      <div class="friends-card">
        <h2 class="friends-card-title">Choose Your Challenge</h2>
        <div class="friends-options">
          <button class="friends-btn create-btn" onclick="showCreateChallenge()">
            <span class="friends-icon">‚úèÔ∏è</span>
            <span class="friends-btn-name">Create Challenge</span>
            <span class="friends-btn-desc">Choose a word for friends to guess</span>
          </button>
          <button class="friends-btn join-btn" onclick="showJoinChallenge()">
            <span class="friends-icon">üîó</span>
            <span class="friends-btn-name">Join Challenge</span>
            <span class="friends-btn-desc">Enter a challenge code from a friend</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Create Challenge Form -->
    <div id="create-challenge-form" class="friends-container" style="display: none;">
      <div class="friends-card">
        <h2 class="friends-card-title">Create Your Challenge</h2>
        <div class="form-content">
          <div class="input-group">
            <label for="challenge-word">Enter a 5-letter word:</label>
            <input type="text" id="challenge-word" class="friends-input" placeholder="HELLO" maxlength="5">
            <div class="input-hint">Choose a word your friends will enjoy guessing!</div>
          </div>
          <button class="friends-btn generate-btn" onclick="generateChallengeCode()">
            <span class="friends-icon">üé≤</span>
            Generate Challenge Code
          </button>
          <div id="code-display" class="code-result" style="display: none;">
            <h3>Share this code with your friends:</h3>
            <div class="code-box">
              <span id="challenge-code" class="code-text"></span>
              <button class="copy-btn" onclick="copyCode()" title="Copy to clipboard">
                <span id="copy-icon">üìã</span>
              </button>
            </div>
            <div class="share-instructions">
              <p>Send this code to your friends so they can guess your word!</p>
            </div>
          </div>
        </div>
        <button class="friends-back-btn" onclick="showMainMenu()">‚Üê Back to Options</button>
      </div>
    </div>

    <!-- Join Challenge Form -->
    <div id="join-challenge-form" class="friends-container" style="display: none;">
      <div class="friends-card">
        <h2 class="friends-card-title">Join a Challenge</h2>
        <div class="form-content">
          <div class="input-group">
            <label for="challenge-code-input">Enter challenge code:</label>
            <input type="text" id="challenge-code-input" class="friends-input" placeholder="ABC123">
            <div class="input-hint">Paste the code your friend shared with you</div>
          </div>
          <button class="friends-btn start-btn" onclick="startFriendsChallenge()">
            <span class="friends-icon">üöÄ</span>
            Start Challenge
          </button>
          <div id="code-error" class="error-message" style="display: none;">
            Invalid challenge code. Please check and try again.
          </div>
        </div>
        <button class="friends-back-btn" onclick="showMainMenu()">‚Üê Back to Options</button>
      </div>
    </div>

    <!-- Friends Challenge Game -->
    <div id="friends-game" class="friends-game" style="display: none;">
      <!-- Challenge Info -->
      <div class="challenge-info">
        <div class="challenge-creator">Challenge by: <span id="creator-name">Friend</span></div>
        <button type="button" id="reset-button" class="friends-reset-btn">New Attempt</button>
      </div>

      <!-- Game Board -->
      <div id="board-container" class="friends-board-container">
        <div id="board" class="friends-board">
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
          <div class="row">
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
            <div class="tile friends-tile" data-status="empty"></div>
          </div>
        </div>
      </div>

      <!-- Friends Keyboard -->
      <div id="keyboard-container" class="friends-keyboard-container">
        <div id="keyboard" class="friends-keyboard">
          <div class="row">
            <button data-key="q" class="friends-key">q</button>
            <button data-key="w" class="friends-key">w</button>
            <button data-key="e" class="friends-key">e</button>
            <button data-key="r" class="friends-key">r</button>
            <button data-key="t" class="friends-key">t</button>
            <button data-key="y" class="friends-key">y</button>
            <button data-key="u" class="friends-key">u</button>
            <button data-key="i" class="friends-key">i</button>
            <button data-key="o" class="friends-key">o</button>
            <button data-key="p" class="friends-key">p</button>
          </div>
          <div class="row">
            <span class="half"></span>
            <button data-key="a" class="friends-key">a</button>
            <button data-key="s" class="friends-key">s</button>
            <button data-key="d" class="friends-key">d</button>
            <button data-key="f" class="friends-key">f</button>
            <button data-key="g" class="friends-key">g</button>
            <button data-key="h" class="friends-key">h</button>
            <button data-key="j" class="friends-key">j</button>
            <button data-key="k" class="friends-key">k</button>
            <button data-key="l" class="friends-key">l</button>
            <span class="half"></span>
          </div>
          <div class="row">
            <button data-key="Enter" class="friends-key one-and-a-half">enter</button>
            <button data-key="z" class="friends-key">z</button>
            <button data-key="x" class="friends-key">x</button>
            <button data-key="c" class="friends-key">c</button>
            <button data-key="v" class="friends-key">v</button>
            <button data-key="b" class="friends-key">b</button>
            <button data-key="n" class="friends-key">n</button>
            <button data-key="m" class="friends-key">m</button>
            <button data-key="Backspace" class="friends-key one-and-a-half">
              <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">
                <path fill="currentColor"
                  d="M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.89 1.59.89h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H7.07L2.4 12l4.66-7H22v14zm-11.59-2L14 13.41 17.59 17 19 15.59 15.41 12 19 8.41 17.59 7 14 10.59 10.41 7 9 8.41 12.59 12 9 15.59z">
                </path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"
    type="module"></script>

  <script>
    // Challenge code encoding/decoding
    function encodeWord(word) {
      // Simple encoding: reverse word + random letters + base64
      const reversed = word.split('').reverse().join('');
      const random = Math.random().toString(36).substring(2, 4).toUpperCase();
      const encoded = btoa(reversed + random).replace(/[+=\/]/g, '').substring(0, 6).toUpperCase();
      return encoded;
    }

    function decodeWord(code) {
      try {
        // Add padding if needed for base64
        let padded = code.toLowerCase();
        while (padded.length % 4) padded += '=';

        const decoded = atob(padded);
        // Remove the last 2 random characters and reverse
        const word = decoded.substring(0, 5).split('').reverse().join('').toUpperCase();

        // Validate word length
        if (word.length === 5 && /^[A-Z]+$/.test(word)) {
          return word;
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    // Navigation functions
    function showMainMenu() {
      document.getElementById('friends-main-menu').style.display = 'block';
      document.getElementById('create-challenge-form').style.display = 'none';
      document.getElementById('join-challenge-form').style.display = 'none';
      document.getElementById('friends-game').style.display = 'none';
      clearForms();
    }

    function showCreateChallenge() {
      document.getElementById('friends-main-menu').style.display = 'none';
      document.getElementById('create-challenge-form').style.display = 'block';
      document.getElementById('join-challenge-form').style.display = 'none';
      document.getElementById('friends-game').style.display = 'none';
    }

    function showJoinChallenge() {
      document.getElementById('friends-main-menu').style.display = 'none';
      document.getElementById('create-challenge-form').style.display = 'none';
      document.getElementById('join-challenge-form').style.display = 'block';
      document.getElementById('friends-game').style.display = 'none';
    }

    function clearForms() {
      document.getElementById('challenge-word').value = '';
      document.getElementById('challenge-code-input').value = '';
      document.getElementById('code-display').style.display = 'none';
      document.getElementById('code-error').style.display = 'none';
    }

    // Challenge creation
    function generateChallengeCode() {
      const wordInput = document.getElementById('challenge-word');
      const word = wordInput.value.trim().toUpperCase();

      if (word.length !== 5) {
        alert('Please enter exactly 5 letters');
        return;
      }

      if (!/^[A-Z]+$/.test(word)) {
        alert('Please use only letters');
        return;
      }

      const code = encodeWord(word);
      document.getElementById('challenge-code').textContent = code;
      document.getElementById('code-display').style.display = 'block';
    }

    // Copy code to clipboard
    async function copyCode() {
      const code = document.getElementById('challenge-code').textContent;
      try {
        await navigator.clipboard.writeText(code);
        const icon = document.getElementById('copy-icon');
        icon.textContent = '‚úÖ';
        setTimeout(() => {
          icon.textContent = 'üìã';
        }, 2000);
      } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = code;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Code copied to clipboard!');
      }
    }

    // Start friends challenge
    function startFriendsChallenge() {
      const codeInput = document.getElementById('challenge-code-input');
      const code = codeInput.value.trim().toUpperCase();

      if (!code) {
        alert('Please enter a challenge code');
        return;
      }

      const word = decodeWord(code);
      if (!word) {
        document.getElementById('code-error').style.display = 'block';
        return;
      }

      // Hide error and start game
      document.getElementById('code-error').style.display = 'none';

      // Initialize game with the decoded word
      window.challengeWord = word;
      startFriendsGame(word);
    }

    // Start the friends game
    async function startFriendsGame(customWord) {
      // Hide menus, show game
      document.getElementById('friends-main-menu').style.display = 'none';
      document.getElementById('create-challenge-form').style.display = 'none';
      document.getElementById('join-challenge-form').style.display = 'none';
      document.getElementById('friends-game').style.display = 'block';

      // Initialize game with custom word
      if (window.initializeGame) {
        await window.initializeGame(customWord);
      }
    }

    // Reset button functionality
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('reset-button').addEventListener('click', function () {
        if (window.challengeWord) {
          startFriendsGame(window.challengeWord);
        }
      });

      // Input validation for word creation
      document.getElementById('challenge-word').addEventListener('input', function (e) {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g, '');
      });

      // Initialize friends challenge mode when page loads
      console.log("Friends Challenge mode DOM loaded");
    });
  </script>
</body>

</html>